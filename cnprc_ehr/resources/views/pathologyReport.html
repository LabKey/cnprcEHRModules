<style type="text/css">

    .pathologyReportRight{
        float: right;
    }

    .pathologyReportLeft{
        float: left;
        width: 40%;
    }

    .pathologyReportCenter {
        margin: auto;
    }

    .summLabelCell {
        width: 10%
    }

    .summValueCell {
        width: 30%
    }

    .reportLabelCell {
        width: 10%
    }

    .reportValueCell {
        width: 50%
    }

    #pathologyBiopsyReport table,
    #pathologyBiopsyReport .biopsyDetailsTable td,
    #pathologyAnimalSummary table
    {
        border: 1px solid lightgray;
    }

    #pathologyAnimalSummary td {
        border: 0px;
    }

    #pathologyAnimalSummary {
        margin-top: 30px;
    }

    #pathologyBody {
        margin: 0px 20px;
    }

    #pathologyAll {
        margin: 10px 10px;
    }

    #pathologyBody h4 {
        margin-top: 30px;
    }

    h4.pathology {
        margin: 0px;
    }

    span.pathology {
        float: left;
        margin-right: 20px;
        font-size: 12px;
    }



</style>
<div id="pathologyAll">
    <div id="pathologyHeader"></div>
    <div id="pathologyBody">
        <div id="pathologyAnimalSummary"></div>
        <div id="pathologyBiopsyReport"></div>
        <div id="pathologyNecropsyReport"></div>
        <div id="imageSection"></div>
    </div>
</div>

<script type="text/javascript">

    +function($) {

        var reportHeader = '';
        var animalSummary = '';
        var biopsyReport = '';
        var necropsyReport = '';
        var images = '';

        var subjectId = LABKEY.ActionURL.getParameter('subjectId');
        var reportId = LABKEY.ActionURL.getParameter('reportId');
        var reportCategory = LABKEY.ActionURL.getParameter('reportCategory');

        showPathologyReport(appendAnimalSummary, appendBiopsyReport, appendNecropsyReport, appendImages);

        function appendHeader() {
            $("#pathologyHeader").html(reportHeader);
        }

        function appendAnimalSummary(animalSummaryData) {

            var idLinkText = '';
            if (animalSummaryData['Id']) {
                if (animalSummaryData['Id'].indexOf("-") !== -1)  // conception ID
                    idLinkText = "<a href='"
                            + LABKEY.ActionURL.buildURL("cnprc_ehr", "conceptionDetail", null, {conceptionId: animalSummaryData['Id']})
                            + "'>" + animalSummaryData['Id'] + "</a>";
                else  // animal ID
                    idLinkText = "<a href='"
                            + LABKEY.ActionURL.buildURL("ehr", "participantView", null, {participantId: animalSummaryData['Id']})
                            + "'>" + animalSummaryData['Id'] + "</a>";
            }

            var locationLinkText = '';
            if (animalSummaryData['location']) {
                var locationSplit = animalSummaryData['location'].split("-");
                if (locationSplit.length === 1) {
                    locationLinkText = "<a href='"
                            + LABKEY.ActionURL.buildURL("ehr", "cageDetails", null, {room: locationSplit[0]})
                            + "'>" + animalSummaryData['location'] + "</a>";
                }
                else if (locationSplit.length === 2) {
                    locationLinkText = "<a href='"
                            + LABKEY.ActionURL.buildURL("ehr", "cageDetails", null, {room: locationSplit[0], cage: locationSplit[1]})
                            + "'>" + animalSummaryData['location'] + "</a>";
                }
            }

            var projectLinkText = '';
            if (animalSummaryData['project']) {
                projectLinkText = "<a href='"
                        + LABKEY.ActionURL.buildURL("cnprc_ehr", "projectDetails", null, {project: animalSummaryData['project']})
                        + "'>" + animalSummaryData['project'] + "</a>";
            }

            animalSummary = "<h4>Summary</h4><table class='table' style=\"width:75%\">" +
            "<tr>\n" +
                "<td class='summLabelCell'><strong>Animal Id:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['Id'] + "</td>\n" +  // TODO: needs to link Animal Summary / Conception Detail
                "<td class='summLabelCell'><strong>Sex:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['sex'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Death Date:</strong></td class='summValueCell'>" + "<td>" + animalSummaryData['deathDate'] + "</td>\n" +
             "</tr>\n" +
            "<tr>\n" +
                "<td class='summLabelCell'><strong>Location:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['location'] + "</td>\n" +  // TODO: needs to link to all animals in location
                "<td class='summLabelCell'><strong>Age:</strong></td>" + "<td class='summValueCell'>" +  animalSummaryData['age'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Death Type:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['deathType'] + "</td>\n" +
            "</tr>\n" +
            "<tr>\n" +
                "<td class='summLabelCell'><strong>Investigator:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['investigator'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Project:</strong></td>" + "<td class='summValueCell'><a href='cnprc_ehr-projectDetails.view?project=" +
                    animalSummaryData['project'] + "'>" + animalSummaryData['project'] + "</a></td>\n" +
                "<td class='summLabelCell'><strong>Charge Id:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['chargeId'] + "</td>\n" +
            "</tr>\n" +
            "<tr>\n" +
                "<td class='summLabelCell'><strong>Pathologist:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['pathologist'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Clinician:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['clinician'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Work Performed: <strong></strong></td>" + "<td class='summValueCell'>" + animalSummaryData['workPerformed'] + "</td>\n" +
            "</tr>\n" +
            "<tr>\n" +
                "<td class='summLabelCell'><strong>Weight (grams): </strong></td>" + "<td class='summValueCell'>" + animalSummaryData['weightInGrams'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Pathology Condition:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['pathologyCondition'] + "</td>\n" +
                "<td class='summLabelCell'><strong>Hydration:</strong></td>" + "<td class='summValueCell'>" + animalSummaryData['hydration'] + "</td>\n" +
            "</tr>\n";

            $("#pathologyAnimalSummary").html(animalSummary);
        }

        function appendBiopsyReport(biopsyData) {
            biopsyReport = "<h4></h4><table class='table' style=\"width:75%\">" +
            "<tr><td class='reportLabelCell'><strong>Clinincal History:</strong></td>" + "<td class='reportValueCell'>" + biopsyData['clinicalHistory'] + "</td></tr>\n" +
            "<tr><td class='reportLabelCell'><strong>Clinincal Diagnosis:</strong></td>" + "<td class='reportValueCell'>" + biopsyData['clinicalDiagnosis'] + "</td></tr>\n" +
            "<tr><td class='reportLabelCell'><strong>Modify Necropsy:</strong></td>" + "<td class='reportValueCell'>" + biopsyData['modifyNecropsy'] + "</td></tr>" +
            "<tr><td class='reportLabelCell'><strong>Biopsy Observations:</strong></td>" + "<td>" +
                    "<table class='table-striped table-hover table-condensed biopsyDetailsTable' style=\"width:100%\">" +
                        "<thead><tr><td>Organ</td>" + "<td>Text</td><tr></thead>";
                            for (i = 0; i < biopsyData['grossFindings'].length; i++) {
                                biopsyReport += "<tr>" +
                                        "<td>"+ biopsyData['grossFindings'][i]['biopsyObsOrgan'] +"</td>" +
                                        "<td>"+ biopsyData['grossFindings'][i]['biopsyObsOrganText'] +"</td>" +
                                        "</tr>";
                            }
                            biopsyReport +=
                     "</table></td></tr>" +
             "<tr><td class='reportLabelCell'><strong>Biopsy Diagnosis:</strong></td>" + "<td>" +
                    "<table class='table-striped table-hover table-condensed biopsyDetailsTable' style=\"width:100%\">" +
                         "<thead><tr><td class='text-center'>Seq</td>" + "<td>Organ</td>"+"<td>Text</td>"+"</tr></thead>";
                            for (i = 0; i < biopsyData['morphologicDiagnosis'].length; i++) {
                                 biopsyReport += "<tr>" +
                                         "<td class='text-center'>"+ biopsyData['morphologicDiagnosis'][i]['morphDiagSeq'] +"</td>" +
                                         "<td >"+ biopsyData['morphologicDiagnosis'][i]['morphDiagOrgan'] +"</td>" +
                                         "<td>"+ biopsyData['morphologicDiagnosis'][i]['morphDiagText'] +"</td>" +
                                         "</tr>";
                             }
                            biopsyReport +=
                    "</table></td></tr>" +
              "<tr><td class='reportLabelCell'><strong>Biopsy Comments:</strong></td>" + "<td class='reportValueCell'>" + biopsyData['biopsyComments'] + "</td></tr>\n" ;

            $("#pathologyBiopsyReport").html(biopsyReport);
        }

        function appendNecropsyReport() {
            $("#pathologyNecropsyReport").html(necropsyReport);
        }

        function appendImages() {
            $("#imageSection").html(images);
        }

        function showPathologyReport(animalSummCallbackFn, biopsyReportCallbackFn, necropsyReportCallbackFn, imagesCallbackFn) {

            var animalSummaryData = {};

            animalSummary = getAnimalSummary(animalSummCallbackFn, animalSummaryData, biopsyReportCallbackFn, necropsyReportCallbackFn, imagesCallbackFn);
        }

        function getAnimalSummary(callbackFn, animalSummaryData, biopsyReportCallbackFn, necropsyReportCallbackFn, imagesCallbackFn) {

            LABKEY.Query.selectRows({
                schemaName: "study",
                queryName: "demographicsPathologyAnimalSummary",
                scope: this,
                failure: LDK.Utils.getErrorCallback(),
                filterArray: [
                    LABKEY.Filter.create('Id', subjectId, LABKEY.Filter.Types.EQUAL),
                    LABKEY.Filter.create('reportId', reportId, LABKEY.Filter.Types.EQUAL)
                ],
                requiredVersion: '17.1',  // want formattedValue for dates
                success: function (result) {
                    var row = result.rows[0].data;

                    animalSummaryData['Id'] = row.Id.value;
                    animalSummaryData['reportName'] = row.reportName.value;
                    animalSummaryData['sex'] = row.sex.value;
                    animalSummaryData['deathDate'] = row.deathDate.formattedValue ? row.deathDate.formattedValue : '';
                    animalSummaryData['deathType'] = row.deathType.value ? row.deathType.value : '';
                    animalSummaryData['weightInGrams'] = row.weightInGrams.value;
                    animalSummaryData['location'] = row.location.value;
                    animalSummaryData['age'] = row.age.displayValue;
                    animalSummaryData['project'] = row.project.value;
                    animalSummaryData['investigator'] = row.investigator.value ? row.investigator.value : '';
                    animalSummaryData['workPerformed'] = row.workPerformed.formattedValue ? row.workPerformed.formattedValue : ''; //TODO: fix: values do not match webvitals
//                    animalSummaryData['dateCompleted'] = row.dateCompleted.formattedValue ? row.dateCompleted.formattedValue : ''; //TODO: probably this is what's required instead of datePerformed
                    animalSummaryData['pathologist'] = row.pathologist.value ? row.pathologist.value : '';
                    animalSummaryData['chargeId'] = row.chargeId.value ? row.chargeId.value : '';
                    animalSummaryData['hydration'] = row.hydration.value ? row.hydration.value : '';
                    animalSummaryData['pathologyCondition'] = row.pathologyCondition.value ? row.pathologyCondition.value : '';
                    animalSummaryData['clinician'] = row.clinician.value ? row.clinician.value : '';

                    if (animalSummaryData['reportName'] === "Biopsy") {

                        reportHeader = getHeaderHtml(reportId, animalSummaryData['reportName']);
                        appendHeader();

                        var biopsyData = {};
                        getBiopsyReport(biopsyData, biopsyReportCallbackFn);
                        images = getImages(imagesCallbackFn);

                    }
                    else {  // necropsy

                        reportHeader = getHeaderHtml(reportId, animalSummaryData['reportName']);
                        appendHeader();

                        getNecropsyReport(necropsyReportCallbackFn);
                        images = getImages(imagesCallbackFn);
                    }

                    callbackFn.call(this, animalSummaryData);
                }
            });
        }

        function getDemographicsInfo(callbackFn) {

            LABKEY.Query.selectRows({
                schemaName: "study",
                queryName: "demographics",
                success: function (result) {

                }
            });
        }

        function getBiopsyReport(biopsyData, callbackFn) {

            var multi = new LABKEY.MultiRequest();

            multi.add(LABKEY.Query.selectRows, {
                schemaName: "study",
                queryName: "pathologyReportBiopsyAndHistory",
                scope: this,
                failure: LDK.Utils.getErrorCallback(),
                filterArray: [
                    LABKEY.Filter.create('Id', LABKEY.ActionURL.getParameter('subjectId'), LABKEY.Filter.Types.EQUAL),
                    LABKEY.Filter.create('reportId', LABKEY.ActionURL.getParameter('reportId'), LABKEY.Filter.Types.EQUAL),
                ],
                success: function (result) {

                    var row = result.rows[0];
                    biopsyData['clinicalHistory'] = row.clinicalHistory;
                    biopsyData['clinicalDiagnosis'] = row.clinicalDiagnosis;
                    biopsyData['modifyNecropsy'] = row.modifyNecropsy;
                    biopsyData['biopsyComments'] = row.biopsyComments;
                }
            });

            multi.add(LABKEY.Query.selectRows, {
                schemaName: "study",
                queryName: "pathologyReportBiopsyGF",
                scope: this,
                failure: LDK.Utils.getErrorCallback(),
                filterArray: [
                    LABKEY.Filter.create('Id', LABKEY.ActionURL.getParameter('subjectId'), LABKEY.Filter.Types.EQUAL),
                    LABKEY.Filter.create('reportId', LABKEY.ActionURL.getParameter('reportId'), LABKEY.Filter.Types.EQUAL),
                ],
                success: function (result) {

                    var rows = result.rows;

                    biopsyData['grossFindings'] = [];
                    for (var i = 0; i < rows.length; i++) {
                        biopsyData['grossFindings'][i] = {
                            biopsyObsOrgan: rows[i].biopsyObsOrgan,
                            biopsyObsOrganText: rows[i].biopsyObsOrganText
                        };
                    }
                }
            });

            multi.add(LABKEY.Query.selectRows, {
                schemaName: "study",
                queryName: "pathologyReportBiopsyMD",
                scope: this,
                failure: LDK.Utils.getErrorCallback(),
                filterArray: [
                    LABKEY.Filter.create('Id', LABKEY.ActionURL.getParameter('subjectId'), LABKEY.Filter.Types.EQUAL),
                    LABKEY.Filter.create('reportId', LABKEY.ActionURL.getParameter('reportId'), LABKEY.Filter.Types.EQUAL),
                ],
                sort: 'morphDiagSeq',
                success: function (result) {

                    var rows = result.rows;
                    biopsyData['morphologicDiagnosis'] = [];
                    for(var i = 0; i < rows.length; i++) {
                        biopsyData['morphologicDiagnosis'][i] = {
                            morphDiagSeq: rows[i].morphDiagSeq,
                            morphDiagOrgan: rows[i].morphDiagOrgan,
                            morphDiagText: rows[i].morphDiagText
                        };
                    }
                }
            });

            multi.send(function(){
                callbackFn.call(this, biopsyData);
            }, this);
        }

        function getNecropsyReport(callbackFn) {
//TODO:
        }

        function getImages(callbackFn) {
            var filterArray = [LABKEY.Filter.create('Id', subjectId, LABKEY.Filter.Types.EQUAL)];
            filterArray.push(LABKEY.Filter.create('prmFk', reportId, LABKEY.Filter.Types.EQUAL));

            var queryName = reportCategory === "Necropsy" ? "necropsy" : "biopsy";

            // Check if module property set
            if (LABKEY.moduleContext["cnprc_ehr"] && LABKEY.moduleContext["cnprc_ehr"]["PathologyReportsFolder"]) {
                var reportsFolder = LABKEY.moduleContext["cnprc_ehr"]["PathologyReportsFolder"];


                LABKEY.Query.selectRows({
                    containerPath: this.containerPath,
                    schemaName: 'study',
                    queryName: queryName,
                    columns: 'prmFk/Id/Id, prmFk/Id/owner_name, prmFk/Id/subject_organ',
                    filterArray: filterArray,
                    scope: this,
                    failure: LDK.Utils.getErrorCallback(),
                    success: function (results) {
                        var id, subfolder, tnPath, orPath, fullTnPath, fullOrPath, first = true, organ, owner;
                        var pipelineRoot = LABKEY.ActionURL.getContextPath() + "/_webdav" + LABKEY.container.path + "/"
                                + reportsFolder + "/@pipeline";

                        for (var i = 0; i < results.rows.length; i++) {
                            id = results.rows[i]['prmFk/Id/Id'];
                            organ = results.rows[i]['prmFk/Id/subject_organ'];
                            owner = results.rows[i]['prmFk/Id/owner_name'];
                            if (id) {

                                subfolder = id.substr(2, 3);
                                tnPath = "/TN/" + subfolder + "/";
                                orPath = "/OR/" + subfolder + "/";

                                fullTnPath = "\"" + pipelineRoot + tnPath + id + ".jpg\"";
                                fullOrPath = "\"" + pipelineRoot + orPath + id + ".jpg\"";

                                if (first) {
                                    images = '<h4>Images</h4>';
                                    first = false;
                                }

                                images += "<span class='pathology'><div><a href=" + fullOrPath + "> <img src=" + fullTnPath + "></a></div>" +
                                        "<div>Image Id: " + id + "</div>" +
                                        "<div>Owner: " + owner + "</div>" +
                                        "<div>Organ: " + organ + "</div>" +
                                        "</span>";
                            }
                        }

                        callbackFn.call(this);
                    }
                });
            }
        }

        function getTimestamp() {
            var d = new Date();
            return d.toLocaleString(); //TODO: does this work, or the date need to be formatted as July 09, 2018 for ex.
        }

        function getHeaderHtml(reportId, reportCategory) {
            var rId = "Report Id: " + reportId + " ";
            var rep = reportCategory + " Report ";
            var ts = getTimestamp();

            return ('<h4 class="pathology">' +
                    '<span class="pathologyReportLeft">' + rId + '</span>' +
                    '<span class="pathologyReportCenter">' + rep + '</span>' +
                    '<span class="pathologyReportRight">' + ts + '</span>' +
                    '</h4>');

        }
    }(jQuery);

</script>